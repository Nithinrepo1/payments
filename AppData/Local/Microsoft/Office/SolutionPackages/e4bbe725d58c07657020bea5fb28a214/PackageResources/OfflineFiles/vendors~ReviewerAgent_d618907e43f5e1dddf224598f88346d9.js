"use strict";(self.webpackChunkTypeScriptModule=self.webpackChunkTypeScriptModule||[]).push([[7410],{34332:(e,t,i)=>{i.r(t),i.d(t,{ReviewerAgent:()=>Ht,ReviewerAgentLaunchType:()=>Qe});var n=i(89125),s=i(69038),o=i(39492),a=i(8520),r=i(43100),d=i(93176),l=i(70825),g=i(32060),c=i(62096),u=i(24643),h=i(93031),p=i(74113),m=i(87396),C=i(80607),S=i(72813),y=i(27708),f=i(1335);i(42410);var E,I,v=i(18620);!function(e){e.ChatECCInjectionError="Chat_ECC_Injection_Error",e.CIQForcedInvokeException="CIQ_Forced_Invoke_Exception",e.CIQThemeUpdateException="CIQ_Theme_Update_Exception",e.EditorBootstrapException="Editor_Bootstrap_Exception",e.EditorShutdownException="Editor_Shutdown_Exception",e.EmailECCInjectionError="Email_ECC_Injection_Error",e.EventECCInjectionError="Event_ECC_Injection_Error",e.FileECCInjectionError="File_ECC_Injection_Error",e.PeopleECCInjectionError="People_ECC_Injection_Error",e.UnsupportedSuggestionTypeError="Unsupported_Suggestion_Type_Error"}(E||(E={})),function(e){e.EditorShutdownSuccess="Editor_Shutdown_Success",e.EditorCIQForceInvoke="Editor_CIQ_Force_Invoke",e.EditorCIQThemeUpdate="Editor_CIQ_Theme_Update",e.EditorBootstrapSuccess="Editor_Bootstrap_Success"}(I||(I={}));var R=i(80233),A=i(93443),w=i(61898),T=i(72295);const D=`${(0,w.l)({environment:"Prod"})}${T.Tx}`,b=["mc-officeEditorTonalEnabled","mc-officeEditorALEnabled","mc-enable-override-critiques:true","mc-editor-oa","maps-editor-locationsuggestions","mc-graphIntentDetection-workflow","mc-graphIntentDetection-model-flight07","mc-graphIntentDetection-model-flight15","mc-graphIntentDetection-allowlist-flight02","mc-editor-oa-nudge","mc-editor-oa-mid-tile-predictions","mc-editor-oa-flags","mc-editor-oa-address-detection","mc-editor-oa-local-business-detection","mc-editor-oa-satori-entity-detection","oa-graph-bestmatch","enable-scope-suggestions","scd-suggestions-toplevel","mc-editor-oa-settings","mc-editor-oa-ecc-annotation","mc-editor-oa-event-ecc","mc-editor-oa-scopes","mc-editor-oa-email-ecc","mc-editor-enable-meeting-banner","mc-editor-expanded-ecc-responsive","mc-editor-oa-debug","mc-editor-enable-meeting-banner"];class P{constructor(){this.staticSettings={isAggregatedLoggingEnabled:!0,controlIconSetName:"FabricMDL2Icons",showOptionsButton:!0,synonymsEndPoint:R.i.Prod,licenseType:A.G_.Subscription,sessionType:0,upsellLink:"https://upselllink",ignoreAllEnabled:!0,ignoreOnceEnabled:!0,enableOptimizedCallingPattern:!0,maxSuggestionItemsDisplayNumber:4,maxSuggestionDisplayPerLanguageNumber:2,enableOrchestration:!0,enableE2eMetric:!0,orchestratorSettings:{enableAugLoop:!0},manageRtlInEditorUx:!1,manageRtlForProofingLanguage:!1,enhancedUpsellEnabled:!1,premiumPreviewEnabled:!1,oaSettings:{isContextualCardEnabled:!0,disableInlineSuggestionTooltips:!0,mockResults:!1,e2eMetric:!0,mockNoAugloopResults:!1,mockResultState:"Default",enableZeroQueryHintText:!0,bestMatchConfig:{enabled:!0,maxResults:L}}},this.getFlightsToTrack=(e,t,i)=>{let n=[...b];return i?.length>0&&(n=n.concat(...i)),t?.enableChatCIQ&&n.push("mc-editor-oa-groupchat-ecc"),t?.enableEmailCIQ&&n.push("mc-editor-oa-email-ecc"),(t?.enableTopicECC||t?.enableTopicCIQ)&&n.push("vivatopics"),e&&n.push("mc-editor-oa-client-ecc"),t?.enableResponsiveExpandedECC&&n.push("mc-editor-expanded-ecc-responsive"),t?.enableNewFileTidbits&&n.push("mc-editor-enable-files-new-tidbits"),t?.enableSearchBar&&(n.push("mc-editor-enable-searchbar"),n.push("mc-editor-attachbutton-searchbar-position")),n}}composeSettings(e,t){const i=Object.assign({},this.staticSettings.oaSettings,{enableOaClient:e.featureFlags?.enableHybridWorkflow,customizedEmptyECCSuggestionsString:e.customizedEmptyECCSuggestionsString,updateResultsTimeout:e.resultTime?e.resultTime:6e3,entitiesEnabled:t,scopesConfig:e.enableAutomaticScoping?{enabled:!0,maxResults:L,enableAutomaticScoping:!0}:{enabled:!0,maxResults:L,enableAutomaticScoping:!1}});return Object.assign({},this.staticSettings,{appId:e.hostAppId,flightsToTrack:this.getFlightsToTrack(!!e.featureFlags?.enableHybridWorkflow,e.featureFlags,e.flightsToTrack),defaultLocale:e.hostDefaultLocale,editorEndPoint:e.isDogfoodEnvironment?R.G.Lab:R.G.Prod,hostMetadata:{appName:e.hostAppName,appPlatform:e.hostAppPlatform,appScenario:e.hostAppScenario,sessionId:e.sessionId,releaseAudienceGroup:e.isDogfoodEnvironment?"Dogfood":"Production"},orchestratorSettings:{enableAugLoop:!0,augLoopEndpoint:e.augloopEndPoint??"https://augloop-dogfood.officeppe.com",augLoopAuthTokenCallback:e.augLoopAuthTokenCallback,substrateAuthTokenCallback:e.substrateAuthTokenCallback},userId:e.userId,oaSettings:i,serviceSettings:{hybridAugloop:{enabled:!!e.featureFlags?.enableHybridWorkflow,enableGraphSearchLocal:!!e.featureFlags?.enableHybridWorkflow,wasmConfig:{binaryPath:D,scriptPath:D}}},isDarkMode:e.isDarkMode,useFluentV9:e.useFluentV9??!1})}}const L=15;function N(e,t){const i=new P,n=function(e){const t=[];return e.forEach((i=>{t.push({enabled:!0,entityType:i,maxResults:1===e.length?void 0:L})})),t}(t);return i.composeSettings(e,n)}var k=i(58651);let F=!1;const U=(e,t)=>{F&&(null==t?k.log("Chat Editor log:",e):k.log("Chat Editor log:",e,t))};function M(e){const t=e?.message;return void 0!==t?t:""}let _;function x(e){_&&(_.logError(e),U(e))}function O(e,t){_&&_.logErrorTelemetry&&_.logErrorTelemetry(e,t)}function B(e,t){_&&_.logSuccessTelemetry&&_.logSuccessTelemetry(e,t)}var q,H=i(99614);!function(e){e.light="light",e.dark="dark",e.highContrast="highContrast",e.custom="custom"}(q||(q={}));var V=i(75264),Q=i(94329),W=i(50616),j=i(55033),z=i(62284),$=i(40144),G=i(3445),J=i(22252),Z=i(7369),K=i(68262),X=i(97790);const Y=(0,Z.a)({palette:{...K.o,themePrimary:"#C43E1C",themeSecondary:"#FF5C39",themeDark:"#DB2A82",themeDarker:"#D67540",themeTertiary:"#B1470E",themeLight:"#F6DBD4",themeDarkAlt:"#C43E1C",themeLighter:"#F558A6",themeLighterAlt:"#FFB700",neutralPrimary:"#242424",neutralLight:"#FFFFFF",neutralLighter:"#EDEBE9",neutralLighterAlt:"#D1D1D1",neutralSecondary:"#616161",neutralSecondaryAlt:"#707070",neutralTertiary:"#F0F0F0",neutralTertiaryAlt:"#F2F2F2",neutralQuaternary:"#BDBDBD",neutralQuaternaryAlt:"#424242",neutralPrimaryAlt:"#E0E0E0",neutralDark:"#242424",black:"#000000"}}),ee=((0,Z.a)({palette:{...X.C,themePrimary:"#CA5010",themeSecondary:"#FF5C39",themeDark:"#DB2A82",themeDarker:"#D67540",themeTertiary:"#B1470E",themeLight:"#6E220F",themeDarkAlt:"#C43E1CFF",themeLighter:"#F558A6FF",themeLighterAlt:"#FFB700FF",neutralPrimary:"#FFFFFF",neutralLight:"#292929",neutralLighter:"#757575",neutralLighterAlt:"#666666",neutralSecondary:"#616161",neutralSecondaryAlt:"#999999",neutralTertiary:"#3D3D3D",neutralTertiaryAlt:"#3D3D3D",neutralQuaternary:"#BDBDBD",neutralQuaternaryAlt:"#FFFFFF",neutralPrimaryAlt:"#E0E0E0",neutralDark:"#FFFFFF",black:"#FFFFFF"}}),({themePalette:e,isDarkMode:t,children:i,className:n})=>{const s={...Y.palette,...e},o=(0,J.i)(s),r=t?(0,z.W)(o):(0,$.a)(o);return a.createElement(G.q,{className:n,theme:r},i)});var te=i(658),ie=i(80617);const ne=(0,te.n)({ciqInputText:{color:ie.L.colorBrandForeground1}}),se=a.forwardRef(((e,t)=>{const{text:i,id:n,copilotChatTheme:s,isDarkModeEnabled:o}=e,[r,d]=(0,a.useState)(e.isLoading),[l,g]=(0,a.useState)(e.clpSensitivityIndicatorData),c=ne();return(0,a.useImperativeHandle)(t,(()=>({setLoading:e=>{d(e)},setSensitivity:e=>{g(e)}}))),a.createElement("span",{contentEditable:!1,className:"user-ciq-selection-id",id:n,style:{display:"inline"}},a.createElement("span",{className:c.ciqInputText},i),a.createElement("span",{style:{display:"inline-block",verticalAlign:"text-bottom"}},r?a.createElement(j.y,{size:"extra-tiny"}):a.createElement(ee,{themePalette:s,isDarkMode:o},l&&a.createElement(W.A,{clpSensitivityIndicatorData:l}))))}));class oe{constructor(){this.ciqId=0,this.ciqUrls=new Map,this.isHVCAppChatV2Enabled=!1,this.queryAnnotationSet=new Map}renderAndTrackSelectedSuggestion(e,t,i,n,s,o){if(!e.suggestion||!e.queryRange)return void U("renderAndTrackSelectedSuggestion: nothing to render");++this.ciqId;const r="userCIQSelectionId-"+this.ciqId;this.ciqUrls.set(r,e.suggestion.url),this.queryAnnotationSet.set(r,e.suggestion.queryAnnotation);const d={text:e.suggestion.text,id:r,clpSensitivityIndicatorData:t,isLoading:i,copilotChatTheme:n,isDarkModeEnabled:s},l=a.createElement(se,{...d,ref:o},null),g=document.createElement("span");if(Q.render(l,g),e.queryRange.endContainer){const t=e.queryRange.endContainer.textContent;t&&" "===t.charAt(t.length-1)&&(e.queryRange.endContainer.textContent=t.slice(0,-1),e.queryRange.setEndAfter(e.queryRange.endContainer),e.queryRange.collapse(!1))}e.queryRange.insertNode(g),g.insertAdjacentText("beforebegin"," "),e.queryRange.collapse(!1);const c=document.createTextNode(" ");e.queryRange.insertNode(c),e.queryRange.setEndAfter(c),e.queryRange.collapse(!1);const u=window.getSelection();u?.removeAllRanges(),u?.addRange(e.queryRange),U("renderAndTrackSelectedSuggestion: rendered suggestion")}generatCopilotOdslSignalLinks(e){if(this.ciqUrls.size<=0)return void U("generatCopilotOdslSignalLinks: nothing to generate");const t=[...this.ciqUrls.keys()];for(const i of t){e.querySelector(`span#${i}`)||this.ciqUrls.delete(i)}if(this.ciqUrls.size<=0)return void U("generatCopilotOdslSignalLinks: nothing to generate after cleanup");const i=[];let n=0;const s=e.childNodes;for(let e=0;e<s.length;e++){const t=s[e];if(t.nodeType===Node.ELEMENT_NODE){const e=t.childNodes[0];if(e&&e.className.includes("user-ciq-selection-id")&&e.id){const t=e.textContent.length;this.ciqUrls.has(e.id)&&i.push({type:V.J.URL,range:[n,n+t],value:this.ciqUrls.get(e.id)}),n+=t}else"BR"===t.nodeName?n++:this.isHVCAppChatV2Enabled&&"SPAN"===t.nodeName&&(n+=t.textContent.length)}else(""!=t.textContent.trim()||n>0)&&(n+=t.textContent.length)}return U(`generatCopilotOdslSignalLinks: ${i.reduce(((e,t)=>e+`URL: ${t.value}, range: [${t.range[0]}, ${t.range[1]}]`),"")}`),i}generateQueryAnnotations(e){if(this.queryAnnotationSet.size<=0)return void U("generateQueryAnnotations: nothing to generate");const t=[...this.queryAnnotationSet.keys()];for(const i of t){e.querySelector(`span#${i}`)||this.queryAnnotationSet.delete(i)}if(this.queryAnnotationSet.size<=0)return void U("generateQueryAnnotations: nothing to generate after cleanup");const i=[],n=e.childNodes;for(let e=0;e<n.length;e++){const t=n[e];if(t.nodeType===Node.ELEMENT_NODE){const e=t.childNodes[0];e&&e.className.includes("user-ciq-selection-id")&&e.id&&this.queryAnnotationSet.has(e.id)&&i.push(this.queryAnnotationSet.get(e.id))}}return U(`generateQueryAnnotations: ${i.reduce(((e,t)=>e+`URL: ${t.id}, text: ${t.text}`),"")}`),i}setHVCAppChatV2Enabled(e){this.isHVCAppChatV2Enabled=e}}const ae={calloutStyles:{marginTop:4,width:300,borderRadius:2},containerStyles:{maxWidth:300,minWidth:300,borderRadius:2,paddingHorizontal:0,paddingTop:0,paddingBottom:8,maxHeight:400},headerStyles:{paddingHorizontal:12},shimmerStyles:{circleSize:32,gapSize:12,lineSize:160,paddingTop:8,paddingHorizontal:12},itemsStyles:{sharedItemStyles:{height:48,paddingHorizontal:12,borderRadius:0,textHorizontalPadding:12,titleFontSize:14,subtitleFontSize:12},personItemStyles:{personaCoinSize:32},fileItemStyles:{iconStyles:{margin:4}},scopeItemStyles:{height:32,iconFontSize:16,personaCoinSize:16}},footerStyles:{height:44,marginHorizontal:0,marginBottom:-4}},re={itemsStyles:{fileItemStyles:{iconStyles:{margin:4}}}};var de=i(90512),le=i(2162);function ge(e){let t,i,n,s;switch(e.type){case de.ck.File:{const o=e;return i=o.FileName,t=o.SpoId??o.AccessUrl,"DownloadableUrl"===o.AccessUrlType&&(n=o.AccessUrl),n||"DownloadableUrl"!==o.AlternateAccessUrlType||(n=o.AlternateAccessUrl),n||(n=o.AccessUrl,n||(n=o.AlternateAccessUrl)),n?(s={QueryAnnotationType:le.in.File,text:i,id:t},{type:de.ck.File,id:t,text:i,url:n,queryAnnotation:s}):(x(`File ECC injection failed due to missing AccessUrl of type ${o.AccessUrlType} and missing AlternateAccessUrl of type ${o.AlternateAccessUrlType}`),void O(E.FileECCInjectionError,`Missing AccessUrl of type ${o.AccessUrlType} and missing AlternateAccessUrl of type ${o.AlternateAccessUrlType}`))}case de.ck.People:{const o=e;return o?.EmailAddresses&&o.DisplayName?(i=o.DisplayName,t=o.EmailAddresses[0],n=o.EmailAddresses[0]?`mailto:${o.EmailAddresses[0]}`:"",s={QueryAnnotationType:le.in.People,text:i,id:t},{type:de.ck.People,id:t,text:i,url:n,queryAnnotation:s}):(x("People ECC injection failed due to missing EmailAddresses or DisplayName"),void O(E.PeopleECCInjectionError,"Missing EmailAddresses or DisplayName"))}case de.ck.Chat:{const o=e;if(!o?.ThreadId)return x("Chat ECC injection failed due to missing ThreadId"),void O(E.ChatECCInjectionError,"Missing ThreadId");if(void 0!==o.Name)i=o.Name;else if(o.ChatMembers){const e=2,t=o.ChatMembers.length-e;let n=o.ChatMembers.slice(0,e).map((e=>e.DisplayName)).join(", ");t>0&&(n+=`, +${t}`),i=n}else i="";return t=o.ThreadId,n="",s={QueryAnnotationType:le.in.Chat,text:i,id:t},{type:de.ck.Chat,id:t,text:i,url:n,queryAnnotation:s}}case de.ck.Message:{const o=e;return o?.ImmutableId?(i=o.Subject,t=o.ImmutableId?.Id,n="",s={QueryAnnotationType:le.in.Message,text:i,id:t},{type:de.ck.Message,id:t,text:i,url:n,queryAnnotation:s}):(x("Email ECC injection failed due to missing ImmutableId"),void O(E.EmailECCInjectionError,"Missing ImmutableId"))}case de.ck.Event:{const o=e;return o?.OriginalId?(i=o.Subject,t=o.OriginalId,n=o.WebLink??"",s={QueryAnnotationType:le.in.Event,text:i,id:t},{type:de.ck.Event,id:t,text:i,url:n,queryAnnotation:s}):(x("Event ECC injection failed due to missing OriginalId"),void O(E.EventECCInjectionError,"Missing OriginalId"))}default:return x(`onItemSelected called with unsupported suggestion type ${e.type}`),void O(E.UnsupportedSuggestionTypeError,`onItemSelected called with unsupported suggestion type ${e.type}`)}}class ce{constructor(e){this.editorProofingNode=void 0,this.editorClient=e}shutdown(){try{U("Shutting down Editor"),this.editorClient.shutDown(),U("Shutting down Editor completed successfully"),B(I.EditorShutdownSuccess)}catch(e){x("Exception shutting down Editor:"+JSON.stringify(e)+" Error message: "+M(e)),O(E.EditorShutdownException," Error message: "+M(e))}this.editorClient=null}initializeCiq(e,t){return this.editorProofingNode&&this.editorClient&&this.uninitialize(t.queryCharToUse),U("Initializing Editor for CIQ"),this.editorProofingNode=this.editorClient.spellCheck(e,".ignore-block"),this.editorClient.enableInlineSuggestionsMenu(t.entitiesEnabled,t.queryCharToUse,((e,i,n)=>{U("Suggestion selected from CIQ: "+JSON.stringify(e)+" in range: "+JSON.stringify(i)),t.onItemSelected({suggestion:ge(e),queryRange:i,parentHtmlElement:n})}),void 0,void 0,{fitToContent:!0},t.ExpanededECC?re:ae,void 0,void 0,void 0,void 0,t.ExpanededECC?void 0:async e=>{U(`${e?.length} suggestions found`),t.onSuggestionsUpdated&&t.onSuggestionsUpdated(e.length);for(const i of e)i.groupTitle=t.menuTitle,i.groupSubtitle=t.menuSubtitle;return e},void 0,void 0,void 0,void 0,void 0,t.getLocalItems,void 0,void 0,void 0,t.ExpanededECC),new oe}uninitialize(e){this.editorProofingNode&&this.editorClient&&(U("Uninitializing Editor"),this.editorClient.disableInlineSuggestionsMenu(e),this.editorClient.detach(this.editorProofingNode),this.editorProofingNode=void 0)}forceInvokeCIQMenu(e,t){if(this.editorProofingNode&&this.editorClient)try{U("Starting to show CIQ for force invoke"),t&&this.setCurrentScope(t),this.editorClient.showExistingMenuAtCursor(1,e,!0),U("Showing CIQ for force invoke"),B(I.EditorCIQForceInvoke)}catch(e){x("Exception showing CIQ for forced invoke:"+JSON.stringify(e)+" Error message: "+M(e)),O(E.CIQForcedInvokeException," Error message: "+M(e))}}updateCurrentTheme(e){try{switch(U(`Starting to update theme for CIQ to ${e}`),e){case q.light:case q.dark:case q.highContrast:case q.custom:this.editorClient.updateCurrentTheme(e);break;default:throw`Unexpected themeType: ${e}`}U("Theme updated for CIQ"),B(I.EditorCIQThemeUpdate)}catch(e){x("Exception updating theme for CIQ:"+JSON.stringify(e)+" Error message: "+M(e)),O(E.CIQThemeUpdateException," Error message: "+M(e))}}normalizeCIQEntity(e){switch(!0){case/file/i.test(e):return H.c.File;case/(people)|(person)/i.test(e):return H.c.People;case/(event)|(meeting)/i.test(e):return H.c.Event;case/chat/i.test(e):return H.c.Chat;case/(message)|(email)/i.test(e):return H.c.Message;case/(topic)/i.test(e):return H.c.Topic;default:return}}setCurrentScope(e){if(!this.editorClient)return;const t=this.normalizeCIQEntity(e);if(void 0===t)return void U(`Invoked setEntityScope with unsupported entity type ${e}`);const i=this.editorClient.exp_getQueryDetection();i?.setCurrentScope({entityType:t},!1)}setUnsupportedEntities(e){if(!this.editorClient)return;const t=this.editorClient.exp_getQueryDetection();t?.setUnsupportedEntities(e)}}class ue{async bootstrap(e){var t,i;t=e.settings.isDogfoodEnvironment,F=t,i=e.telemLogger,_=i,U("bootstrapEditor called");try{const t=await(0,v.Rc)(N(e.settings,e.entitiesSupported),e.telemSink,e.augloopSession);await t.initializeSDK(),await t.initializeUX(document),this.chatEditor=new ce(t),U("bootstrapEditor completed successfully"),B(I.EditorBootstrapSuccess)}catch(e){throw x("Exception bootstrapping Editor:"+JSON.stringify(e)+" Error message: "+M(e)),O(E.EditorBootstrapException," Error message: "+M(e)),e}return this.chatEditor}shutdown(){return this.chatEditor.shutdown()}}class he{createInstance(){return new ue}}var pe=i(30112),me=i(87144),Ce=i(16895);const Se={color:ie.L.colorNeutralForeground4,alignItems:"flex-start",...me.g.body1,fontStyle:"normal",...Ce.Pt.gap("1px"),content:"attr(title)"},ye={color:ie.L.colorNeutralForegroundDisabled,"@media (forced-colors: active)":{forcedColorAdjust:"none"}},fe={...me.g.body1,alignItems:"flex-start",fontStyle:"normal",...Ce.Pt.gap("1px"),whiteSpace:"pre-wrap",display:"inline-block",width:"100%","&:focus":{...Ce.Pt.outline(0)}},Ee={userInput:{...fe,"&:focus":{...Ce.Pt.outline(0)},"&:focus::after":Se,"&::after":Se}},Ie={userInput:{...fe,"&:focus":{...Ce.Pt.outline(0)}}},ve={userInput:{"&:focus::after":ye,"&::after":ye}},Re=((0,te.n)(Ie),(0,te.n)(Ee)),Ae=(0,te.n)(ve),we="";var Te=i(58651);const De=e=>{const{isDisabled:t=!1,placeholderText:i=we,editorProps:n,onItemSelected:s,overrideStyles:o,startInMenuOpenState:r,queryCharToUse:d}=e,l=d??"/",g=a.useRef(),c=(0,a.useRef)(!0),[u,h]=a.useState(void 0),p=(0,a.useRef)(null),[m,C]=(0,a.useState)(void 0),[S,y]=(0,a.useState)(i),f=a.useCallback((()=>{if(!t&&n?.handleInChatInput&&n?.editorConfig&&!g.current&&n?.alSession){if(!c.current)return n?.editorConfig?.telemLogger?.logSuccessTelemetry("Editor_Bootstrap_Skipped","ShouldBootStrapEditor is false"),void Te.log("EditorBootstrapping is skipped as shouldBootStrapEditor is false");const t=(new he).createInstance();c.current=!1,t.bootstrap((e=n.editorConfig,i=n.alSession,{...e,augloopSession:i})).then((e=>{g.current=t,h(e)}))}var e,i}),[n?.alSession,n?.handleInChatInput,n?.editorConfig,t]);(0,a.useEffect)((()=>{f()}),[f]),(0,a.useEffect)((()=>()=>{g.current&&(g.current.shutdown(),g.current=void 0,h(void 0),C(void 0),c.current=!0)}),[n?.alSession,n?.handleInChatInput,n?.editorConfig]),(0,a.useEffect)((()=>{if(n?.handleInChatInput&&n?.editorConfig&&!m&&u&&p.current){const t=u.initializeCiq(p.current,{menuTitle:n?.editorConfig.transformFileMenuTitle,menuSubtitle:n?.editorConfig.transformFilePlaceholderText?n?.editorConfig.transformFilePlaceholderText:we,queryCharToUse:l,getLocalItems:e.getLocalItems,onItemSelected:async e=>{Te.log(e),s&&s(e.suggestion),Te.log("Item Selected"),n.postCIQItemSelectionHandler&&n.postCIQItemSelectionHandler(e.suggestion)},entitiesEnabled:n?.editorConfig.entitiesSupported,ExpanededECC:n?.editorConfig.isExpandedECCEnabled});C(t)}}),[u,m]);const E=(0,a.useRef)(Ae()),I=(0,a.useRef)(Re()),[v,R]=(0,a.useState)(I.current.userInput);(0,a.useEffect)((()=>{t&&R((0,pe.z)(I.current.userInput,E.current.userInput))}),[t]),(0,a.useEffect)((()=>{const e=p.current;r&&u&&e&&m&&(e.innerText=l,e.focus(),e.lastChild?window.getSelection().setPosition(e.lastChild,e.lastChild.textContent.length):e.firstChild&&window.getSelection().setPosition(e.firstChild,e.firstChild.textContent.length),u.forceInvokeCIQMenu(l))}),[p.current,r,u,m]);return a.createElement("span",{className:v,title:S,ref:p,contentEditable:!0,onInput:e=>{e.target.textContent===we?y(i):e.target.textContent.length>0&&S!==we&&y(we)},style:o})},be="Done! Your review has been started. Feel free to ask me for a status update at any time.",Pe="Check review status",Le="Close this review",Ne="Edit review details",ke="Confirm",Fe="Something went wrong while executing this request",Ue=new Map([[p.I.EntryPointCard,"ReviewAgentEntryPointCard"],[p.I.ConfirmInvitationCard,"ReviewAgentConfirmInvitationCard"],[p.I.ReviewStatusCard,"ReviewAgentReviewStatusCard"],[p.I.SuggestionCard,"ReviewAgentSuggestionsCard"]]),Me=["Retrieving session information...","Checking for active reviews...","Setting up context..."],_e=["Processing your request...","Setting up due date & reminders....","Notifying your reviewers...."],xe=["Updating reviewer counts...","Analyzing recent comments...","Compiling feedback..."],Oe=["Processing feedback...","Generating actionable suggestions...","Creating a prioritized list..."],Be=["Terminating active processes...","Clearing review data...","Finalizing review closure..."],qe="https://microsoft.sharepoint-df.com/:w:/t/PPTOFastFoodTest/EX7Rw-e3ymlAmYUT6BVj12kBd9VTzVczouXYlEsewBGZsg?e=o2Fb5X",He="Retry",Ve=864e5;var Qe;!function(e){e.LAUNCH_WITH_REVIEWERS="LAUNCH_WITH_REVIEWERS",e.LAUNCH_WITHOUT_REVIEWERS="LAUNCH_WITHOUT_REVIEWERS",e.LAUNCH_FROM_TOGGLE="LAUNCH_FROM_TOGGLE"}(Qe||(Qe={}));class We{static generateId(){return We.operationId++,"AugLoopChatAgent-Reviewer"+We.operationId.toString()}}var je,ze,$e,Ge,Je;We.operationId=0,function(e){e.Client="Client",e.Server="Server"}(je||(je={})),function(e){e.ErrorMessage="ErrorMessage",e.ErrorCode="ErrorCode",e.ErrorType="ErrorType",e.ErrorCategory="ErrorCategory"}(ze||(ze={})),function(e){e.ReviewerAgentPeoplePickerEditorConfigNotProvided="people-picker-editor-config-not-provided"}($e||($e={})),function(e){e.AgentCreated="Agent_Created",e.AgentClosed="Agent_Closed",e.AgentStatusChanged="Agent_Status_Changed",e.WorkflowRegisterd="Workflow_Registered",e.AddDetailsButtonClicked="Add_Details_Button_Clicked",e.StartReviewButtonClicked="Start_Review_Button_Clicked",e.SendResponseToClient="Send_Response_To_Client",e.ChatPaneLoaded="Chat_Pane_Loaded",e.DefaultSignalOperation="Default_Signal_Operation",e.SendRequestToAL="Send_Request_To_AL",e.SendInitialSignal="Send_Initial_Signal",e.SendCloseAgentSignal="Send_Close_Agent_Signal",e.SendUIStateSyncSignal="Send_UI_State_Sync_Signal",e.SendUIStateSyncSignalZeroReviewers="Send_UI_State_Sync_Signal_Zero_Reviewers",e.InvitationRenderCardRequest="Invitation_Render_Card_Request",e.ProcessSummaryCard="Process_Summary_Card"}(Ge||(Ge={})),function(e){e.AgentId="AgentId",e.AgentStatus="AgentStatus",e.AgentEventType="AgentEventType",e.AgentEventParameters="AgentEventParameters"}(Je||(Je={}));const Ze="";var Ke,Xe;!function(e){e.NONE="None",e.ONE_DAY_BEFORE="1 day before",e.THREE_DAYS_BEFORE="3 days before"}(Ke||(Ke={})),function(e){e.INIT="Init",e.COMPLETED="Completed",e.CRITICAL="Critical",e.ACTIVE="Active",e.INACTIVE="Inactive",e.FAILED="Failed",e.EXPIRED="Expired"}(Xe||(Xe={}));var Ye=i(43479),et=i(7573),tt=i(98483),it=i(58651);const nt=({displayName:e,mail:t})=>({query:"create agent",queryId:(0,tt.A)(),createAgent:{templateName:"ReviewSync",mode:S.Z.CREATE,propValues:JSON.stringify({AUTHOR:{displayName:e,mail:t}})}}),st=e=>({query:"Show Suggestion",queryId:(0,tt.A)(),agentId:e,suggestionCardSignal:{agentId:e}}),ot=e=>({query:"clean up agent",agentId:e,queryId:(0,tt.A)(),cleanupSignal:{agentId:e}}),at=(e,t)=>{let i={query:e,queryId:(0,tt.A)()};return t&&(i={...i,agentId:t}),i},rt=(e,t)=>{const i=JSON.stringify(e);return{query:"UI STATE SYNC",queryId:(0,tt.A)(),agentId:t,uiStateSync:{jsonPayload:i}}},dt=(e,t,i,n)=>({query:"suggestion applied",queryId:(0,tt.A)(),agentId:e,suggestionActionSignal:{agentId:e,commentId:t,changeType:i,isValid:n}}),lt=e=>{const t=JSON.parse(e);return t?t.mode:S.Z.NONE},gt=e=>{const t=JSON.parse(e)?.payload;return t?t.agentId:""},ct=(e,t)=>{const i=JSON.parse(e)?.payload,n=i?.agentStatus??"";return""===n?t:n},ut=(e,t="Hello, welcome back. How can I help you today?")=>{let i;try{i=JSON.parse(e)?.payload}catch(t){it.log("Error in parsing payload",t),it.log("Response message",e)}return i?i.displayMessage:t},ht=e=>{let t;try{t=JSON.parse(e)?.payload}catch(t){it.log("Error in parsing payload",t),it.log("Response message",e)}return it.log("ReviewerAgent:: payload: ",t),t},pt=e=>void 0!==JSON.parse(e).uiType,mt=e=>JSON.parse(e).uiType;function Ct(e){if(e instanceof Date)return e;const t="string"==typeof e?parseInt(e):e;return new Date(t)}function St(e){const t=e.trim(),i=Number(t);if(isNaN(i))return NaN;const n=parseInt(t,10);return i===n?n:NaN}function yt(e={}){const t={};for(const i in e.props||{})t[i]=e.props[i]?.defaultValue;return t}const ft=(e,t=!1)=>{const i={};for(const n of e)if(n)switch(n.kind){case h.T.DATE_PICKER:{const e=yt(n);if(t)e.selectedDate=Ct(e.selectedDate);else{const t=new Date;t.setDate(t.getDate()+7),0===t.getDay()?t.setDate(t.getDate()+1):6===t.getDay()&&t.setDate(t.getDate()+2),e.selectedDate=t}i[h.T.DATE_PICKER]=e}break;case h.T.TEXT_AREA:{const e=yt(n);i[h.T.TEXT_AREA]=e}break;case h.T.PEOPLE_PICKER:{const e=yt(n);i[h.T.PEOPLE_PICKER]=e}break;case h.T.DROP_DOWN:{const e=yt(n);if(e.displayValue=Ke.NONE,t){if(e.selectedValue=e.selectedValue||Ke.NONE,e.selectedValue!==Ke.NONE)if(isNaN(St(e.selectedValue)))e.selectedValue=Ke.NONE,e.displayValue=Ke.NONE;else{const t=new Date(parseInt(e.selectedValue)).toDateString();e.displayValue=t}}else e.selectedValue=Ke.NONE;i[h.T.DROP_DOWN]=e}break;case h.T.SUBMIT:{const e=yt(n);i[h.T.SUBMIT]=e}break;default:throw new Error(`Unsupported kind: ${n.kind}`)}return i};function Et(e=It){return{type:Ye.jA.Default,title:He,text:He,iconRegular:et.DXr,iconHover:et.fC9,handleButtonOnClick:e}}const It=async(e,t,i)=>{vt("Retry button clicked"),Lt.getInstance().removeActionButtonFromLastCard(),Lt.getInstance().showActionCard(He),await Lt.getInstance().invokeReviewAgent()},vt=(...e)=>{it.log("ReviewerAgent::"+(new Date).toUTCString(),...e)},Rt=e=>{const t=[],i=new Date;for(const n in Ke){let s=new Date(e),o=0;switch(Ke[n]){case Ke.ONE_DAY_BEFORE:o=1;break;case Ke.THREE_DAYS_BEFORE:o=3;break;case Ke.NONE:t.push(Ke.NONE);break;default:continue}const a=s.getTime()-o*Ve;if(o>0&&a>=i.getTime()){s=new Date(a);const e=s.toLocaleDateString(),i=`${Ke[n]} (${e})`;t.push(i)}}return t};async function At(e,t,i){vt("ReviewerAgent:: suggestionCallback called"),await Lt.getInstance().onApplySuggestion(e,t,i),await Lt.getInstance().sendSuggestionActionSignal(e,i)}function wt(e){vt("ReviewerAgent:: suggestion navigation clickedcalled"),Lt.getInstance().onSuggestionCardNavigation(e)}function Tt(e,t){if("None"!==e&&"None"!==t){return 0!==function(e,t){const i=Dt(e),n=Dt(t),s=(i-n)/Ve;return Math.floor(Math.abs(s))}(e,t)}return e!==t}function Dt(e){let t;if(!(e instanceof Date)){const i=Number(e);t=isNaN(i)?new Date(e):new Date(i)}const i=t.getTime();if(isNaN(i))throw new Error(`Provided date ${e} is invalid`);return i}function bt(e,t,i,n,s){e.sendTelemetryAgentEventData([{key:Je.AgentEventType,value:t},{key:Je.AgentEventParameters,value:i},{key:Je.AgentId,value:n},{key:Je.AgentStatus,value:s}])}var Pt=i(58651);class Lt extends r.h{sendSuggestionSignal(){this.copilotChatRef.current?.addChatMessages([{messageType:d._.ChatCardWrapper,body:{user:"human",element:"Show Suggestions"}}]);const e={documentConfig:{documentURL:this.documentURL}},t={...st(this.agentID),config:e};this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(t)}]}),workflowAnnotationType:C.xj.getTypeName()}),this.copilotChatRef.current?.startLoadingUi()}constructor(e,t,i,s,o,r,l,c,u,m,C){super(),this.commentId="",this.documentURL=qe,this.userQuery="",this.authorName="",this.authorMail="",this.message="",this.date=null,this.reminder="",this.agentID="",this.agentStatus=Xe.INIT,this.isInitialCardShown=!1,this.isReturningUser=!1,this.firstMessageText="",this.annotationId=void 0,this.telemetryLoggerUtils=n.j.getInstance(),this.agentLaunchType=Qe.LAUNCH_WITH_REVIEWERS,this.processInvitationRenderCardRequest=e=>{Pt.log("ReviewerAgent::  processInvitationRenderCardRequest response ",e);const t=ht(e);Pt.log("ReviewerAgent::  processInvitationRenderCardRequest payload ",t);const i=t?.props||t?.additionalPayload?.props||{},n=i?.headerText||t?.additionalPayload?.headerText;Pt.log("ReviewerAgent::  processInvitationRenderCardRequest payload.props ",i);const s=function(e){let t=(0,tt.A)();return t=e?`EditReviewDetails-${t}`:`${Ue.get(p.I.ConfirmInvitationCard)}-${t}`,t}(this.isReturningUser);this.confirmInvitationCardProps={headerText:n,individualComponentPropsMap:ft(i,this.isReturningUser),messageId:s},this.isReturningUser?this.returningUserReviewDetailsProps=JSON.parse(JSON.stringify(this.confirmInvitationCardProps)):this.returningUserReviewDetailsProps=void 0;const o=this.confirmInvitationCardProps.individualComponentPropsMap[h.T.PEOPLE_PICKER],r=this.confirmInvitationCardProps.individualComponentPropsMap[h.T.TEXT_AREA],d=this.confirmInvitationCardProps.individualComponentPropsMap[h.T.DATE_PICKER],l=this.confirmInvitationCardProps.individualComponentPropsMap[h.T.DROP_DOWN],c=this.confirmInvitationCardProps.individualComponentPropsMap[h.T.SUBMIT];var u,m,C,S,y;this.reviewers=[],o&&(Array.isArray(o.suggestions)||(o.suggestions=o.suggestions?.value||[]),this.isReturningUser?(o.suggestions.forEach((e=>{e.isReadOnly=!0})),this.reviewers=o.suggestions):o.suggestions=this.reviewers,this.peoplePickerEditorConfig||(Pt.error("ReviewerAgent::  processInvitationRenderCardRequest peoplePickerEditorConfig is not provided"),u=this.telemetryLoggerUtils,m="ReviewerAgent::  processInvitationRenderCardRequest peoplePickerEditorConfig is not provided",C=je.Server,S=$e.ReviewerAgentPeoplePickerEditorConfigNotProvided,y=g.S2.Error,u.sendTelemetryAgentErrorData([{key:ze.ErrorMessage,value:m},{key:ze.ErrorType,value:C},{key:ze.ErrorCode,value:S},{key:ze.ErrorCategory,value:y}])),o.inputComponent=((e,t,i)=>{let n;return i&&(n={editorConfig:i,alSession:e,handleInChatInput:!0}),a.createElement(De,{editorProps:n,placeholderText:"Type / to add reviewers",onItemSelected:t})})(this.session,this.onItemSelected,this.peoplePickerEditorConfig),o.onPeopleRemoved=e=>{this.reviewers=this.reviewers.filter((t=>t.mail!==e.mail)),o.suggestions=this.reviewers,this.isReturningUser&&c&&(c.isFormReadyForSubmission=this.validateBeforeSubmit()),this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage())}),r&&(this.message=r.message,r.onMessageChange=e=>{Pt.log("ReviewerAgent::  onMessageChange message ",e),this.message=e,(0===this.message.trim().length||this.message.trim().length>0&&c&&!c.isFormReadyForSubmission)&&(c.isFormReadyForSubmission=this.validateBeforeSubmit(),this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage()))}),d&&(this.date=d.selectedDate.getTime(),d.onDateChange=e=>{Pt.log("ReviewerAgent::  onDateChange date ",e),e.setHours(23,59,59,999),this.date=e.getTime(),this.reminder=Ke.NONE,l&&(l.selectedValue=this.reminder,l.displayValue=this.reminder,l.options=Rt(this.date)),c&&(c.isFormReadyForSubmission=this.validateBeforeSubmit()),this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage())}),l&&(this.date&&(l.options=Rt(this.date)),this.reminder=l.selectedValue,l.onItemSelected=e=>{if(Pt.log("ReviewerAgent::  onDateChange item ",e),e.includes("1 day")){const e=this.date-864e5;this.reminder=e.toString()}else if(e.includes("3 days")){const e=this.date-2592e5;this.reminder=e.toString()}else{const t=new Date(e);isNaN(t.getTime())?this.reminder=e:this.reminder=new Date(e).toString()}c&&(c.isFormReadyForSubmission=this.validateBeforeSubmit()),l.selectedValue=this.reminder,l.displayValue=e,this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage())}),c&&(c.onSubmit=()=>this.sendUIStateSyncSignal()),Pt.log("ReviewerAgent::  processInvitationRenderCardRequest this.confirmInvitationCardProps: ",this.confirmInvitationCardProps),this.isReturningUser||this.agentLaunchType!==Qe.LAUNCH_WITH_REVIEWERS||this.showInvitationCard(),bt(this.telemetryLoggerUtils,Ge.InvitationRenderCardRequest,Ze,this.agentID??Ze,this.agentStatus??Ze)},this.showInvitationCard=()=>{this.confirmInvitationCardProps.individualComponentPropsMap[h.T.SUBMIT].isFormReadyForSubmission=this.validateBeforeSubmit(),this.copilotChatRef.current?.addResponseMessage(this.getConfirmInvitationCardResponseMessage())},this.getConfirmInvitationCardResponseMessage=()=>{const e=this.confirmInvitationCardProps.messageId||Ue.get(p.I.ConfirmInvitationCard);return{chatCardType:d._.ReviewAgentCard,chatMessageData:{reviewAgentCardProps:{user:"chat",reviewAgentIndividualCardProps:{reviewAgentCardType:p.I.ConfirmInvitationCard,reviewAgentInternalCardProps:this.confirmInvitationCardProps}}},chatMessageBodyData:{messageId:e}}},this.onItemSelected=e=>{const t={displayName:e.text,mail:e.id};if(!this.reviewers.find((e=>e.mail===t.mail))){if(this.reviewers.push(t),this.confirmInvitationCardProps.individualComponentPropsMap[h.T.PEOPLE_PICKER].suggestions=this.reviewers,this.isReturningUser){const e=this.confirmInvitationCardProps?.individualComponentPropsMap?.[h.T.SUBMIT];e&&(e.isFormReadyForSubmission=this.validateBeforeSubmit())}this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage())}},this.copilotChatRef=e,this.session=t,this.userQuery=i||"Start a review on this document",this.documentURL=s||qe,this.authorName=o||"Aditya Aswal",this.authorMail=r||"aditysasaaswal@microsoft.com",this.setSuggestionList=l,this.isReviewerNotAddedButtonClicked=c||!1,this.agentLaunchType=u,this.getDocumentSensitivity=m,this.peoplePickerEditorConfig=C}setCallbacks(e,t,i,n){this.onApplySuggestion=e,this.toggleChangeHandler=t,this.addCommentToFirstLineOfDocument=i,this.onSuggestionCardNavigation=n}setFastModeReviewerAgentEnabled(e){this.isFastModeReviewerAgentEnabled=e}getAgentStatus(){return this.agentStatus}static getInstance(e,t,i,n,s,o,a,r,d,l,g){return Lt.instance||(Lt.instance=new Lt(e,t,i,n,s,o,a,r,d,l,g)),Lt.instance}static destroy(){Pt.log("ReviewerAgent:: Destroying CopilotCommunicationHandlerImpl instance."),Lt.instance=void 0}getWorkflowsToRegister(){Pt.log("ReviewerAgent:: getWorkflowsToRegister.");const e=[];return e.push({workflowAnnotationType:C.xj.getTypeName(),shouldHandleResponse:!1,augloopResponseTimerRequired:!0,augloopResponseTimeout:65e3}),Pt.log("ReviewerAgent:: Registered workflows"),bt(this.telemetryLoggerUtils,Ge.WorkflowRegisterd,"ReviewerAgentWorkflowRegistered",this.agentID??Ze,this.agentStatus??Ze),e}handoffInitialCard(){this.isInitialCardShown||this.agentLaunchType==Qe.LAUNCH_FROM_TOGGLE||(this.showStartupCard(),this.isInitialCardShown=!0)}showStartupCard(){this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.Default,chatMessageData:{defaultMessageProps:{user:"human",messageHeader:{text:"Start reviewersync"}}},stopLoadingUi:!0})}showAcknowledgementCard(){this.isReviewerNotAddedButtonClicked&&(this.firstMessageText=be),this.firstMessageText&&this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.MarkdownCard,chatMessageData:{markDownCardProps:{message:this.firstMessageText}},stopLoadingUi:!0})}getPlainTextChatCardResponse(e,t="chat",i=!0){return{chatCardType:d._.Default,chatMessageData:{defaultMessageProps:{user:t,messageHeader:{text:e}}},stopLoadingUi:i}}async handleRetryButtonClickedForAgentFailure(e,t,i){this.sendUIStateSyncSignal(),this.removeActionButtonFromLastCard()}sendResponseToClient(e){Pt.log("ReviewerAgent:: SendResponseToClient.",e),this.isReturningUser=!1;const t=e.id;if(!this.annotationId||this.annotationId!==t){if(this.annotationId&&this.annotationId===t||(this.annotationId=t),e.body.chatResponse?.status===f.lC.Success){this.handoffInitialCard();const t=e.body.chatResponse?.messages;if(t?.length>=2){this.agentLaunchType===Qe.LAUNCH_FROM_TOGGLE&&this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.ReviewAgentCard,chatMessageData:{reviewAgentCardProps:{user:"chat",reviewAgentIndividualCardProps:{reviewAgentCardType:p.I.EntryPointCard,reviewAgentInternalCardProps:{isTriggeredFromReviewerAgentPane:!0,onAddDetailsButtonClick:()=>{this.isReviewerNotAddedButtonClicked=!1,this.showAcknowledgementCard(),this.showInvitationCard(),Pt.log("onAddDetailsButtonClick"),bt(this.telemetryLoggerUtils,Ge.AddDetailsButtonClicked,Ze,this.agentID??Ze,this.agentStatus??Ze)},onStartReviewButtonClick:()=>{this.isReviewerNotAddedButtonClicked=!0,this.sendUIStateSyncSignalZeroReviewers(),this.copilotChatRef.current?.startLoadingUi(),Pt.log("onStartReviewButtonClick"),bt(this.telemetryLoggerUtils,Ge.StartReviewButtonClicked,Ze,this.agentID??Ze,this.agentStatus??Ze)}}}}}}),this.firstMessageText=this.isReviewerNotAddedButtonClicked?be:t[0]?.text,this.firstMessageText&&this.agentLaunchType!==Qe.LAUNCH_FROM_TOGGLE&&this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.MarkdownCard,chatMessageData:{markDownCardProps:{message:this.firstMessageText}},stopLoadingUi:!0});const e=t[1]?.text;if(Pt.log("ReviewerAgent:: SendResponseToClient secondMessage mode: ",lt(e)),(e=>{it.log("ReviewerAgent::  responseMessageText.",e);try{return void 0!==ht(e)}catch(e){return it.log("ReviewerAgent::  responseMessageText parsing error: ",e),!1}})(e)&&lt(e)===S.Z.CREATE){Pt.log("ReviewerAgent:: Create Agent responsePayLoad: ",e),this.agentID=gt(e);const t=ct(e,this.agentStatus);this.agentStatus=t,this.agentLaunchType===Qe.LAUNCH_WITHOUT_REVIEWERS?this.sendUIStateSyncSignalZeroReviewers():this.processInvitationRenderCardRequest(e)}}else if(1===t?.length&&lt(t[0]?.text)===S.Z.RETURNINGUSER){this.isReturningUser=!0;const e=t[0]?.text;this.agentID=gt(e);const i=ct(e,this.agentStatus);if(this.agentStatus=i,pt(e)&&mt(e)===y.aq.SUMMARYCARD)Pt.log("ReviewerAgent:: Returning user with responsePayLoad: ",e),this.processSummaryCard(e);else if(pt(e)&&mt(e)===y.aq.SUGGESTIONCARD)Pt.log("ReviewerAgent:: Returning user with responsePayLoad: ",e),this.processSuggestionCard(e);else{new Set([Xe.INIT,Xe.COMPLETED,Xe.FAILED,Xe.EXPIRED]).has(i)?this.setSuggestionList([]):this.setSuggestionList([Ne,Pe,Le]);const e=t[0]?.text;this.agentID=gt(e),this.commentId=(e=>{try{const t=JSON.parse(e)?.payload?.additionalPayload;return t?t.agentCommentId:""}catch(e){return it.log("Error in parsing agentCommentId",e),""}})(e),this.processInvitationRenderCardRequest(e);const n=ct(e,this.agentStatus);this.agentStatus=n,Pt.log("ReviewerAgent:: Returning user with responsePayLoad,show suggestion pills ");const s=this.getPlainTextChatCardResponse(ut(e));this.copilotChatRef.current?.addResponseMessage(s)}}}else if(e.body.chatResponse?.status===f.lC.ErrorInExecution){const t=e.body.chatResponse?.messages?.[0]?.text||"{}",i=ht(t),n=this.getPlainTextChatCardResponse(ut(t,Fe));if(i?.agentStatus===Xe.INIT&&this.confirmInvitationCardProps&&this.confirmInvitationCardProps.isCardSubmitted){const e={...n,chatMessageBodyData:{actionButtonList:[Et(this.handleRetryButtonClickedForAgentFailure.bind(this))]}};this.copilotChatRef.current?.addResponseMessage(e),this.setSuggestionList([])}else{this.copilotChatRef.current?.addResponseMessage(n);const e=n.chatMessageData.defaultMessageProps.messageHeader.text;e.includes("Only the document creator")&&e.includes("can initiate the review process.")?this.setSuggestionList([]):this.setSuggestionList([Ne,Pe,Le])}}else{const t=e.body.chatResponse?.messages?.[0]?.text,i=this.getPlainTextChatCardResponse(ut(t,Fe));this.copilotChatRef.current?.addResponseMessage(i),this.setSuggestionList([Ne,Pe,Le])}bt(this.telemetryLoggerUtils,Ge.SendResponseToClient,1==this.isReturningUser?"ReturningUser":"NewUser",this.agentID??Ze,this.agentStatus??Ze)}}processSuggestionCard(e){const t=((e,t,i,n)=>(it.log("ReviewerAgent:: data: ",e),{suggestionIndices:(e?.props?.[0]?.props?.suggestionIndices||[]).map((e=>({onSuggestionCardNavigation:i,onApplySuggestion:t,initialText:e.initialText,suggestedText:e.suggestedText,commentId:e.commentId,changeType:e.changeType,appName:n})))}))(ht(e),At,wt,this.peoplePickerEditorConfig?.settings?.hostAppName?.toLowerCase()||"");this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.ReviewAgentCard,chatMessageData:{reviewAgentCardProps:{user:"chat",reviewAgentIndividualCardProps:{reviewAgentCardType:p.I.SuggestionCard,reviewAgentInternalCardProps:t}}},chatMessageBodyData:{messageId:Ue.get(p.I.SuggestionCard)},stopLoadingUi:!0}),this.setSuggestionList([Ne,Pe,Le])}processSummaryCard(e){const t=ht(e),i=t.props.map((e=>{let t={reviewersWithAction:[],statusMessage:"",labelForReviewedPeople:"",labelForPendingPeople:"",commentsSummaryHeader:"",commentsSummaries:[]};return t=e.props,t}));const n=t?.props?.[0]?.props.areSuggestionsGenerated;this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.ReviewAgentCard,chatMessageData:{reviewAgentCardProps:{user:"chat",reviewAgentIndividualCardProps:{reviewAgentCardType:p.I.ReviewStatusCard,reviewAgentInternalCardProps:i[0]}}},chatMessageBodyData:{messageId:Ue.get(p.I.ReviewStatusCard)},stopLoadingUi:!0}),n?this.setSuggestionList([Ne,"Show suggestions",Pe,Le]):this.setSuggestionList([Ne,Pe,Le]),Pt.log("ReviewerAgent:: processSummaryCard payload: ",t),bt(this.telemetryLoggerUtils,Ge.ProcessSummaryCard,Ze,this.agentID??Ze,this.agentStatus??Ze)}async sendEventToClient(e,t){Pt.log("ReviewerAgent:: SendEventToClient.",e),e==c.PV.CopilotChatLoaded&&(this.invokeReviewAgent(),bt(this.telemetryLoggerUtils,Ge.ChatPaneLoaded,"SendEventToClient",this.agentID??Ze,this.agentStatus??Ze))}async invokeReviewAgent(){var e;(e=this.getDocumentSensitivity?await this.getDocumentSensitivity():void 0)&&e.parent&&(it.log("ReviewerAgent:: sensitivity: ",e),1)?this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.Default,chatMessageData:{defaultMessageProps:{user:"chat",messageHeader:{text:"I'm sorry, but I can't assist you in initiating a review as this document is marked confidential. Please take a moment to review the sensitivity label and try again."}}},chatMessageBodyData:{actionButtonList:[Et()]},stopLoadingUi:!0}):(Pt.log("ReviewerAgent:: Sending initial signal"),this.sendInitialSignal())}getDefaultSignalOperation(e,t,i,n,s){let o;Pt.log("ReviewerAgent:: getDefaultSignalOperation.",e,t),bt(this.telemetryLoggerUtils,Ge.DefaultSignalOperation,e,this.agentID??Ze,this.agentStatus??Ze);const a={documentConfig:{documentURL:this.documentURL}};var r;e.toLowerCase().includes("status")?(o={...(r=this.agentID,{query:"status review of agent",queryId:(0,tt.A)(),agentId:r,summaryCardSignal:{agentId:r}}),config:a},this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:xe})):e.toLowerCase().includes("close")?o={...ot(this.agentID),config:a}:e.toLowerCase().includes("suggestion")?(o={...st(this.agentID),config:a},this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:Oe})):e.toLowerCase().includes("start")?(o={...nt({mail:this.authorMail,displayName:this.authorName}),config:a},this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:Me})):o={...at(e,this.agentID)};const d={operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(o)}]}),workflowAnnotationType:C.xj.getTypeName()};return Promise.resolve(d)}getHostSettings(){return{appName:"Testing",appPlatform:"All",devBuild:!0,environment:c.DF.DEV,sessionId:"",augloopUrl:"http://localhost:20080"}}getAuthToken(){return Pt.log("ReviewerAgent:: getauthtoken"),Promise.resolve("")}shouldSendRequestToAugloop(e){if(e.toLowerCase().includes(Le.toLowerCase())){const t=new Set([Xe.ACTIVE,Xe.CRITICAL,Xe.INACTIVE]);return bt(this.telemetryLoggerUtils,Ge.SendRequestToAL,e,this.agentID??Ze,this.agentStatus??Ze),t.has(this.agentStatus)?(this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.ReviewAgentCard,chatMessageData:{reviewAgentCardProps:{user:"chat",reviewAgentIndividualCardProps:{reviewAgentCardType:p.I.EntryPointCard,reviewAgentInternalCardProps:{isTriggeredFromReviewerAgentPane:!0,isSecondHeaderHidden:!0,isIconHidden:!0,buttonLeftText:ke,buttonRightText:"Cancel",reviewAgentDescriptionText:"Closing the review will end access to suggestions and summaries generated for this session. This action cannot be undone.",onAddDetailsButtonClick:()=>{Pt.log("Cancel button clicked for close agent reviewer"),this.setSuggestionList([Ne,Pe,Le])},onStartReviewButtonClick:()=>{this.copilotChatRef.current?.addResponseMessage({chatCardType:d._.Default,chatMessageData:{defaultMessageProps:{user:"human",messageHeader:{text:ke}}},stopLoadingUi:!0}),this.copilotChatRef.current?.startLoadingUi(),this.sendCloseAgentSignal(),this.setSuggestionList([])}}}}}}),this.setSuggestionList([Ne,Pe])):(this.copilotChatRef.current?.addResponseMessage(this.getPlainTextChatCardResponse("Unable to close review at this moment.")),this.setSuggestionList([Ne,Pe])),Promise.resolve(!1)}if(e.toLowerCase().includes(Ne.toLowerCase())){if(new Set([Xe.ACTIVE,Xe.INACTIVE,Xe.CRITICAL]).has(this.agentStatus)){const e=this.confirmInvitationCardProps?.individualComponentPropsMap?.[h.T.SUBMIT];e&&(e.isFormReadyForSubmission=this.validateBeforeSubmit()),this.copilotChatRef.current?.addResponseMessage(this.getConfirmInvitationCardResponseMessage()),this.setSuggestionList([Pe,Le])}else this.copilotChatRef.current?.addResponseMessage(this.getPlainTextChatCardResponse("Unable to edit review details at this moment.")),this.setSuggestionList([Pe,Le]);return Promise.resolve(!1)}return Promise.resolve(!0)}async getALSession(){if(Pt.log("getALSession"),this.session)return this.session;throw new Error("Session is not undefined")}sendInitialSignal(){Pt.log("sendInitialSignal"),bt(this.telemetryLoggerUtils,Ge.SendInitialSignal,Ze,this.agentID??Ze,this.agentStatus??Ze);const e={documentConfig:{documentURL:this.documentURL}},t={...nt({mail:this.authorMail,displayName:this.authorName}),config:e};this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(t)}]}),workflowAnnotationType:C.xj.getTypeName()}),this.copilotChatRef.current?.startLoadingUi(),this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:Me})}async sendCloseAgentSignal(){Pt.log("sendCloseAgentSignal"),bt(this.telemetryLoggerUtils,Ge.SendCloseAgentSignal,Ze,this.agentID??Ze,this.agentStatus??Ze);const e={documentConfig:{documentURL:this.documentURL}},t={...ot(this.agentID),config:e};this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(t)}]}),workflowAnnotationType:C.xj.getTypeName()}),this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:Be})}getUpdatedReviewDetailsData(){let e={};const t=this.returningUserReviewDetailsProps?.individualComponentPropsMap?.[h.T.DATE_PICKER];"string"==typeof t?.selectedDate&&(t.selectedDate=new Date(t.selectedDate));const i=t?.selectedDate?.getTime();this.date!==i&&(e={...e,DUE_DATE:this.date});const n=this.returningUserReviewDetailsProps?.individualComponentPropsMap?.[h.T.DROP_DOWN]?.selectedValue||Ke.NONE;Tt(this.reminder,n)&&(e={...e,REMINDER_CADENCE:this.reminder});const s=this.returningUserReviewDetailsProps?.individualComponentPropsMap?.[h.T.PEOPLE_PICKER]?.suggestions||[],o=this.reviewers.filter((e=>!s.some((t=>e.mail===t.mail))));return o.length&&(e={...e,REVIEWERS:o.map((e=>({...e,commentId:this.commentId,context:this.message})))}),e}getUIStateSyncData(){if(this.isReturningUser){return this.getUpdatedReviewDetailsData()}return{INVITE_EMAIL:this.message,DUE_DATE:this.date,FAST_MODE_ENABLED:this.isFastModeReviewerAgentEnabled,REMINDER_CADENCE:this.reminder,REVIEWERS:this.reviewers.map((e=>({...e,commentId:this.commentId,context:this.message}))),AUTHOR:{displayName:this.authorName,mail:this.authorMail}}}async sendUIStateSyncSignal(){this.reviewers.length>0&&await this.notifyClientOnReviewInitiation(),this.confirmInvitationCardProps.isCardSubmitted=!0,this.confirmInvitationCardProps.individualComponentPropsMap[h.T.SUBMIT].isFormReadyForSubmission=!1,this.copilotChatRef.current?.updateMessage(this.getConfirmInvitationCardResponseMessage()),Pt.log("sendUIStateSyncSignal"),bt(this.telemetryLoggerUtils,Ge.SendUIStateSyncSignal,Ze,this.agentID??Ze,this.agentStatus??Ze);const e=this.getUIStateSyncData(),t={documentConfig:{documentURL:this.documentURL}},i={...rt(e,this.agentID),config:t};this.copilotChatRef.current?.startLoadingUi(),this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(i)}]}),workflowAnnotationType:C.xj.getTypeName()}),this.copilotChatRef.current?.updateLoadingComponentProps({loadingUiStringList:_e}),this.setSuggestionList([Pe,Le])}validateBeforeSubmit(){if(this.isReturningUser){const e=this.getUpdatedReviewDetailsData(),t=e.DUE_DATE&&e.DUE_DATE>Date.now(),i=e.REVIEWERS&&e.REVIEWERS.length;return!(!t&&!i)}return this.message.length>0&&this.date>Date.now()}async sendUIStateSyncSignalZeroReviewers(){Pt.log("sendUIStateSyncSignalZeroReviewers"),bt(this.telemetryLoggerUtils,Ge.SendUIStateSyncSignalZeroReviewers,Ze,this.agentID??Ze,this.agentStatus??Ze);const e=new Date;e.setDate(e.getDate()+7);const t={INVITE_EMAIL:"",DUE_DATE:e.getTime(),REMINDER_CADENCE:"1 day before",REVIEWERS:[],AUTHOR:{displayName:this.authorName,mail:this.authorMail}},i={documentConfig:{documentURL:this.documentURL}},n={...rt(t,this.agentID),config:i};Pt.log("sendUIStateSyncSignalZeroReviewers textTile",n),this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(n)}]}),workflowAnnotationType:C.xj.getTypeName()}),this.setSuggestionList([Pe,Le])}async notifyClientOnReviewInitiation(){const e=`[via Reviewer]\n\nHello ${this.reviewers.map((e=>e.displayName)).join(", ")}\n\nHere's how you can help with this document review:\n"${this.message}"`;Pt.log(e),this.commentId=await this.addCommentToFirstLineOfDocument(e??"Please review this document",this.commentId)}showActionCard(e){this.copilotChatRef.current.addResponseMessage({chatCardType:d._.Default,chatMessageData:{defaultMessageProps:{user:u.Q9.Human,messageHeader:{text:e}}}})}removeActionButtonFromLastCard(){this.copilotChatRef.current.updateLastMessage({chatCardType:d._.Default,chatMessageBodyData:{actionButtonList:[]},addCardToChatHistory:!1})}sendSuggestionActionSignal(e,t){vt("sendSuggestionActionSignal");const i={documentConfig:{documentURL:this.documentURL}},n={...dt(this.agentID,e,t,!1),config:i};this.copilotChatRef.current?.submitOperation({operation:new l.g0({parentPath:["Signal",m.br.getTypeName()],items:[{id:We.generateId(),body:new m.br(n)}]}),workflowAnnotationType:C.xj.getTypeName()})}}var Nt=i(58651);const kt=(e,t)=>{Nt.log("onAgentToggleChangeStub")},Ft=(e,t,i)=>{Nt.log("onApplySuggestionStub: ",e,t,i)},Ut=e=>{Nt.log("onSuggestionCardNavigationStub: ",e)},Mt=e=>(Nt.log("addCommentToFirstLineOfDocument: ",e),Promise.resolve("Comment added successfully")),_t={themePrimary:"#598FEC",themeSecondary:"#8763c2",themeLight:"#0E336A",themeDark:"#464FEB",themeTertiary:"#598FEC",themeDarker:"#353696",themeMedium:"#464FEB",themeDarkAlt:"#3D91FF",themeLighterAlt:"#6CEBE2",themeLighter:"#9270FF",neutralPrimary:"#FFFFFF",neutralLight:"#292929",neutralLighter:"#757575",neutralLighterAlt:"#666666",neutralSecondaryAlt:"#FFFFFF",neutralTertiary:"#3D3D3D",neutralTertiaryAlt:"#3D3D3D",neutralQuaternaryAlt:"#FFFFFF",neutralDark:"#2461CA",black:"#FFFFFF",white:"#000000"},xt={themePrimary:"#185abd",themeSecondary:"#8763c2",themeLight:"#D2E0F4",themeDark:"#82ABF1",themeTertiary:"#598FEC",themeDarker:"#598FEC",themeMedium:"#82ABF1",themeDarkAlt:"#3D91FF",themeLighterAlt:"#6CEBE2",themeLighter:"#9270FF",neutralLighter:"#f5f5f5",neutralDark:"#1651AA",white:"#FFFFFF"};var Ot=i(88539);const Bt=(0,te.n)((0,Ot.f)({chatFreStack:{height:"calc(100vh - 50px)"},chatUiStack:{top:"20px"}}));var qt=i(58651);const Ht=({isTestApp:e=!1,copilotTelemetryHandler:t,alSession:r,documentURL:d,userQuery:l,onReviewerAgentToggleChange:g,onApplySuggestion:c,addCommentToFirstLineOfDocument:u,onSuggestionCardNavigation:h,peoplePickerEditorConfig:p,isDarkModeEnabled:m=!1,isHighContrastModeEnabled:C=!1,authorName:S,authorEmail:y,isReviewerNotAddedButtonClicked:f=!1,agentLaunchType:E=Qe.LAUNCH_WITH_REVIEWERS,getDocumentSensitivity:I,isReviewerToggleEnabled:v=!1})=>{qt.log("ReviewerAgent: ",r,"IsTestApp: ",e);const R=a.useRef(null),[A,w]=(0,a.useState)([]);(0,a.useEffect)((()=>{}),[A]);const T=async(e,t,i)=>{qt.log("ReviewerAgent:: onApplySuggestionsCbk: ",e,t,i),c&&await c(e,t,i)},D=async e=>{qt.log("ReviewerAgent:: onSuggestionCardNavigationStubCbk: ",e);const t=parseInt(e,16);await h(t.toString())};e&&(l="create agent",d="https://www.microsoft.com",S="Aditya Test",y="test@msft.com");const b=Lt.getInstance(R,e?void 0:r,l,d,S,y,w,f,E,I,p);e?b.setCallbacks(Ft,kt,Mt,Ut):b.setCallbacks(T,g,u,D);const P={settings:{hostAppId:"Word_Online",hostAppName:"Word",hostAppPlatform:"Web",hostAppScenario:"Copilot",hostDefaultLocale:"en-US",isDogfoodEnvironment:!0,resultTime:1e4},telemLogger:{logError:e=>{qt.log("Shared Copilot CIQ Error Log: ",e)}},entitiesSupported:[],isExpandedECCEnabled:!1},L={headerText:"Reviewer",descriptionText:"I'm the ultimate partner for document reviews, and can help you launch, track progress and resolve review comments.",freImagePath:i(99948),hideGetStartedButton:!0},[N,k]=a.useState(!1),F={trySydneyToggleChecked:!1,trySydneyToggleEnabled:!1,tryWebSearchToggleEnabled:!1,trySydneyToggleOnChange:(e,t)=>{qt.log("officeaicopilot-test-app: onChange for Try Sydney Toggle")},tryEnterpriseSearchToggleChecked:!1,tryEnterpriseSearchToggleEnabled:!1,tryEnterpriseSearchToggleOnChange:(e,t)=>{qt.log("officeaicopilot-test-app: onChange for Enterprise Search Toggle")},tryReviewerAgentToggleChecked:!0,tryReviewerAgentToggleEnabled:v,tryReviewerAgentToggleOnChange:g,FastModeReviewerAgentToggleChecked:N,FastModeReviewerAgentToggleEnabled:b.getAgentStatus()===Xe.INIT,FastModeReviewerAgentToggleOnChange:(e,t)=>{const i=!N;b.setFastModeReviewerAgentEnabled(i),k(i)}},U=Bt(),M=((e,t)=>({isDarkModeEnabled:e,isHighContrastModeEnabled:t,...e?_t:xt}))(m,C);return(0,a.useEffect)((()=>(n.j.setTelemetryHandler(t),()=>{Lt.destroy()})),[]),a.createElement(o.B,{className:"ms-welcome",style:{display:"flex",gap:"8px",margin:"0px 4px"}},e||r?a.createElement(s.zn,{style:U,chatUiProps:{chatInputV2Props:{pluginsInfo:[],chatPlaceholderMessage:"Type a message for Reviewer",editorConfig:P},changeTopicUiProps:{hideChangeTopicButton:!0},freUiProps:L,toggleUiProps:F,suggestionPillsUiProps:{suggestionList:A}},copilotCommunicationHandler:b,useALRuntime:!!e,copilotTelemetryHandler:t,ref:R,theme:M}):a.createElement("div",null,"ReviewerAgent: alSession is required for non test"))};Ht.displayName="Reviewer"},99948:(e,t,i)=>{e.exports=i.p+"assets/fre-reviewer-agent-illustration.svg"}}]);
//# sourceMappingURL=vendors~ReviewerAgent.js.map